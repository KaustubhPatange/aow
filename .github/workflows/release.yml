name: Chocolatey

on:
  push:
    branches:
      - master

jobs:
  choco:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
      - name: Build
        run: cargo build --release
      - name: Release on chocolatey
        run: |
          copy target\release\aow.exe choco\tools\aow.exe

          # Below commands will update the VERFICATION.txt file with the new sha256 of the exe file.
          # Unfortunately, CertUtils is not available for PS so we use standard Get-FileHash command.

          $sha = ((Get-FileHash choco\tools\aow.exe | Format-List | findstr Hash) -split ':')[1].trim()
          echo "Generated by `CertUtil -hashfile aow.exe SHA256`:" > choco\tools\VERIFICATION.txt
          echo "" >> choco\tools\VERIFICATION.txt
          echo $sha >> choco\tools\VERIFICATION.txt

          # Below commands will update the nuspec file.

          $version = ((Get-Content -Path .\cargo.toml)[3] -split '=')[1].trim().replace('"',"") 
          $nuspec = (Get-Content -Path choco\aow.nuspec)
          $nuspec[4] = "<version>${version}</version>"
          Set-Content -Path choco\aow.nuspec -Value $nuspec

          # Optionally display the outputs

          echo $sha
          echo $version
          echo $nuspec

          # Install the cli tool

          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          choco apikey --key ${{ secrets.CHOCOLATEY }} --source https://push.chocolatey.org/

          # Create the nupkg

          cd choco
          choco pack aow.nuspec
          move *.nupkg aow.nupkg
          dir
          choco push aow.nupkg --source https://push.chocolatey.org/

      - name: Release on Cargo
        run: |
          cargo login ${{ secrets.CRATES }}
          cargo publish --allow-dirty



  notification:
    needs: [choco]
    runs-on: ubuntu-latest
    steps:
      - name: Sending complete notifications
        env:
          DISCORD_WEBHOOK: ${{ secrets.WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
          args: "{{ EVENT_PAYLOAD.repository.full_name }} - A new package is published on chocolatey."
